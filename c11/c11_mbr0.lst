     1                                           ;代码清单11-1
     2                                           ;文件名：c11_mbr0.asm
     3                                           ;文件说明：硬盘主引导扇区代码 
     4                                           ;创建日期：2020-6-7 15:00
     5                                        
     6                                           ;计算GDT所在的逻辑段地址 
     7 00000000 2EA1[A27C]                       mov ax,[cs:gdt_base+0x7c00]        ;低16位，这是以cs=0为起始的段，所以ax里存的就是物理地址
     8 00000004 2E8B16[A47C]                     mov dx,[cs:gdt_base+0x7c00+0x02]   ;高16位，gdt_base其实是一个偏移量
     9 00000009 BB1000                           mov bx,16        
    10 0000000C F7F3                             div bx                             ;除以16就得到了逻辑段地址和偏移地址
    11 0000000E 8ED8                             mov ds,ax                          ;令ds指向该段逻辑段地址以进行操作
    12 00000010 89D3                             mov bx,dx                          ;令bx指向段内起始偏移地址 
    13                                        
    14                                           ;创建0#描述符，它是空描述符，这是处理器的要求
    15 00000012 66C70700000000                   mov dword [bx+0x00],0x00
    16 00000019 66C7470400000000                 mov dword [bx+0x04],0x00
    17                                  
    18                                           ;创建#1描述符，保护模式下的数据段描述符（文本模式下的显示缓冲区） 
    19 00000021 66C74708FFFF0080                 mov dword [bx+0x08],0x8000ffff     
    20 00000029 66C7470C0B924000                 mov dword [bx+0x0c],0x0040920b     ;段描述符里有很多信息，这里的段基地址是000b8000
    21                                  
    22                                           ;初始化描述符表寄存器GDTR
    23 00000031 2EC706[A07C]0F00                 mov word [cs: gdt_size+0x7c00],15  ;描述符表的界限（总字节数减一）   
    24                                                                               
    25 00000038 2E0F0116[A07C]                   lgdt [cs: gdt_size+0x7c00]
    26                                        
    27 0000003E E492                             in al,0x92                         ;南桥芯片内的端口 
    28 00000040 0C02                             or al,0000_0010B
    29 00000042 E692                             out 0x92,al                        ;打开A20
    30                                  
    31 00000044 FA                               cli                                ;保护模式下中断机制尚未建立，应禁止中断 
    32                                                                              
    33 00000045 0F20C0                           mov eax,cr0
    34 00000048 6683C801                         or eax,1
    35 0000004C 0F22C0                           mov cr0,eax                        ;设置PE位
    36                                           
    37                                           ;以下进入保护模式... ...
    38                                           
    39 0000004F B90800                           mov cx,00000000000_01_000B         ;加载数据段选择子(0x01)到段选择器，发现要选的是1号描述符，就是第2个，里面存的段基地址是000b8000
    40 00000052 8ED9                             mov ds,cx                          ;让段选择器ds指向显存，现在ds描述符高速缓存器里里保存的基地址是b8000
    41                                  
    42                                           ;以下在屏幕上显示"Protect mode OK." 
    43 00000054 C606000050                       mov byte [0x00],'P'  
    44 00000059 C606020072                       mov byte [0x02],'r'
    45 0000005E C60604006F                       mov byte [0x04],'o'
    46 00000063 C606060074                       mov byte [0x06],'t'
    47 00000068 C606080065                       mov byte [0x08],'e'
    48 0000006D C6060A0063                       mov byte [0x0a],'c'
    49 00000072 C6060C0074                       mov byte [0x0c],'t'
    50 00000077 C6060E0020                       mov byte [0x0e],' '
    51 0000007C C60610006D                       mov byte [0x10],'m'
    52 00000081 C60612006F                       mov byte [0x12],'o'
    53 00000086 C606140064                       mov byte [0x14],'d'
    54 0000008B C606160065                       mov byte [0x16],'e'
    55 00000090 C606180020                       mov byte [0x18],' '
    56 00000095 C6061A004F                       mov byte [0x1a],'O'
    57 0000009A C6061C004B                       mov byte [0x1c],'K'
    58                                  
    59 0000009F F4                               hlt                                ;已经禁止中断，处理器将不会被唤醒 
    60                                  
    61                                  ;-------------------------------------------------------------------------------
    62                                       
    63 000000A0 0000                             gdt_size         dw 0              ;保存GDT的界限值
    64 000000A2 007E0000                         gdt_base         dd 0x00007e00     ;GDT的物理地址 
    65                                                               
    66 000000A6 00<rep 158h>                     times 510-($-$$) db 0
    67 000001FE 55AA                                              db 0x55,0xaa
